<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>File Manager | Kawser Portal</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen">
  <nav class="bg-blue-600 text-white px-6 py-4 flex justify-between items-center">
    <h1 class="text-xl font-bold">üìÅ My Files</h1>
    <button onclick="logout()" class="bg-red-500 hover:bg-red-600 px-4 py-2 rounded">Logout</button>
  </nav>

  <main class="p-6">
    <div class="mb-6">
      <input type="file" id="fileInput" class="mb-2">
      <button onclick="uploadFile()" class="bg-blue-600 text-white py-2 px-4 rounded hover:bg-blue-700">Upload File</button>
    </div>
    <h2 class="text-lg font-semibold mb-2">Uploaded Files</h2>
    <ul id="fileList" class="space-y-2"></ul>
  </main>

  <script src="firebase.js"></script>
  <script>
    let currentUser;

    auth.onAuthStateChanged(user => {
      if (!user) return window.location.href = "index.html";
      currentUser = user;
      listFiles();
    });

    function logout() {
      auth.signOut().then(() => window.location.href = "index.html");
    }

    function uploadFile() {
      const file = document.getElementById("fileInput").files[0];
      if (!file) return alert("Please choose a file.");

      const storageRef = firebase.storage().ref(`users/${currentUser.uid}/${file.name}`);
      storageRef.put(file).then(() => {
        alert("‚úÖ File uploaded successfully");
        listFiles();
      }).catch(err => alert("‚ùå " + err.message));
    }

    function listFiles() {
      const fileList = document.getElementById("fileList");
      fileList.innerHTML = "Loading...";
      const userFolder = firebase.storage().ref(`users/${currentUser.uid}/`);

      userFolder.listAll()
        .then(result => {
          fileList.innerHTML = "";
          if (result.items.length === 0) {
            fileList.innerHTML = "<li class='text-gray-500'>No files found.</li>";
          }
          result.items.forEach(fileRef => {
            fileRef.getDownloadURL().then(url => {
              const li = document.createElement("li");
              li.className = "flex justify-between bg-white shadow p-3 rounded";
              li.innerHTML = `
                <a href="${url}" target="_blank" class="text-blue-600 underline">${fileRef.name}</a>
                <button onclick="deleteFile('${fileRef.name}')" class="text-red-500 hover:underline">Delete</button>
              `;
              fileList.appendChild(li);
            });
          });
        });
    }

    function deleteFile(filename) {
      if (!confirm("Are you sure to delete this file?")) return;
      const ref = firebase.storage().ref(`users/${currentUser.uid}/${filename}`);
      ref.delete()
        .then(() => {
          alert("‚úÖ File deleted successfully");
          listFiles();
        })
        .catch(error => alert("‚ùå " + error.message));
    }
  </script>
</body>
</html>
